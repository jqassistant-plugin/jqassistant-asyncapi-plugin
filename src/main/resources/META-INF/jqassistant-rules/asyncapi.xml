<jqassistant-rules xmlns="http://schema.jqassistant.org/rule/v1.10"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://schema.jqassistant.org/rule/v1.10 https://schema.jqassistant.org/plugin/jqassistant-rule-v1.10.xsd">

    <concept id="asyncapi:Channels">
        <description>Merges channel descriptors with the same address (e.q. in different files).
        </description>
        <cypher><![CDATA[
                MATCH (c1:Channel),(c2:Channel)
                WHERE c1.address=c2.address AND c1<>c2
                MERGE (c1)-[:MAPS_TO]->(c2)
                RETURN count(*) as Channels
        ]]></cypher>
        <verify>
            <aggregation/>
        </verify>
    </concept>
    <concept id="asyncapi:Operations">
        <requiresConcept refId="asyncapi:Channels" />
        <description>Merges sending operations to the receiving operation.
        </description>
        <cypher><![CDATA[
               MATCH (operationSend:Operation{action:"send"})-[:ON_CHANNEL]->(:Channel)-[*]->(:Channel)-[:MAPS_TO]->(:Channel)<-[*]-(:Channel)<-[:ON_CHANNEL]-(operationReceive:Operation)
               MERGE (operationSend)-[:SENDS_TO]->(operationReceive)
               RETURN count(*) as Operations
        ]]></cypher>
        <verify>
            <aggregation/>
        </verify>
    </concept>
    <concept id="asyncapi:resolveReferences">
        <description>Sets a "RESOLVES_TO"-relation between a reference object and the actual referenced object. Covers a chain of 2 references as well.
        </description>
        <cypher><![CDATA[
               MATCH (node:AsyncAPI)-[r]->(source:Reference:AsyncAPI)-[:REFERENCES*1..2]->(target:AsyncAPI)
               WHERE NOT (target)-[:REFERENCES]->(:AsyncAPI) AND NOT (node)-[:REFERENCES]->(source)
               MERGE (source)-[:RESOLVES_TO]->(target)
               RETURN count(source) as Source, count(node) as Node
        ]]></cypher>
        <verify>
            <aggregation/>
        </verify>
    </concept>
</jqassistant-rules>
